<!doctype html>
<html lang="en">
<head>
    <link rel="preload" href="../css/sprintboardStyle.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="../css/sprintboardStyle.css"></noscript>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sprint Board</title>
    <link rel="shortcut icon" type="image/jpeg" href="../favicon.jpeg">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css?2917">
    <link rel="stylesheet" type="text/css" href="../style.css?4034">
    <link rel="stylesheet" type="text/css" href="../css/animate.min.css?9837">
    <link rel="stylesheet" type="text/css" href="../css/feather.min.css">
    <link rel="stylesheet" type="text/css" href="../css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../css/ionicons.min.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins:100,500,700,40&display=swap&subset=latin,latin-ext'
          rel='stylesheet' type='text/css'>

</head>
<body data-clean-url="true">

<!-- Preloader -->
<div id="page-loading-blocs-notifaction" class="page-preloader"></div>

<!-- Main container -->
<div class="page-container">
    <!-- Logo Sidebar -->
    <div class="logo-sidebar">
        <div class="icon-container">
            <picture>
                <source type="image/webp" srcset="../img/lazyload-ph.png" data-srcset="../img/favicon.webp">
                <img src="../img/lazyload-ph.png" data-src="../img/favicon.jpeg" class="lazyload" alt="favicon.jpeg">
            </picture>
            <div class="text-center mt-lg-4">
                <span class="icon-md feather-icon icon-content-left icon-672"></span>
            </div>
        </div>
    </div>

    <!-- Links Sidebar -->
    <div class="links-sidebar">
        <div class="button-container">
            <a href="../backlog/index.html"
               class=" btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-laptop icon-7097 me-lg-3 "></span>Product Backlog
            </a>
            <a href="../sprintboard/index.html"
               class="btn btn-lg mb-lg-3 btn-c-672 btn-style ps-lg-0 btn-clean-clicked product-backlog-btn">
                <span class="icon-spacer fa fa-running  icon-7647 icon-md me-lg-3"></span>Sprint Board
            </a>
            <a href="../" class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3">
                <span class="icon-spacer ion ion-android-people icon-md me-lg-3"></span>Team members
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="bloc l-bloc" id="bloc-1">
            <div class="container bloc-lg">
                <div class="row align-items-center">
                    <div class="col">

                        <!-- Sprint Cards Container -->
                        <div id="sprintCardsContainer" class="sprint-cards-container">
                            <!-- Sprint cards will be dynamically added here -->
                        </div>
                        <div class="form-group mb-3">
                            <button class="btn btn-lg btn-9-style btn-c-7647" id="addSprintButton">
                                <span class="fa fa-plus"></span> Add Sprint
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Delete Confirmation Popup -->
    <div id="delete-confirmation-popup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Confirm Deletion</h4>
            <p>Are you sure you want to delete this item?</p>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>


    <!-- Sprint Form Popup -->
    <div id="sprintFormPopup" class="popup-form">
        <form id="sprintForm">
            <div class="form-group">
                <label for="sprintTitle">Title</label>
                <input type="text" class="form-control" id="sprintTitle" placeholder="Enter Sprint Title">
            </div>
            <div class="form-group">
                <label for="sprintDescription">Description</label>
                <textarea class="form-control" id="sprintDescription" rows="3"
                          placeholder="Enter sprint description"></textarea>
            </div>
            <div class="form-group">
                <label for="productOwner">Product Owner:</label>
                <select class="form-control" id="productOwner">
                    <option>test1</option>
                    <option>test2</option>
                    <option>test3</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scrumMaster">Scrum Master:</label>
                <select class="form-control" id="scrumMaster">
                    <option>test1</option>
                    <option>test2</option>
                    <option>test3</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sprintStartTime">Sprint Start Time:</label>
                <input type="datetime-local" class="form-control" id="sprintStartTime">
            </div>
            <div class="form-group">
                <label for="sprintEndTime">Sprint End Time:</label>
                <input type="datetime-local" class="form-control" id="sprintEndTime">
            </div>
            <div class="form-group">
                <label for="sprintStatus">Status:</label>
                <div id="sprintStatus"></div>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleSaveSprint()">Save Sprint</button>
            </div>
        </form>
    </div>

    <!-- ScrollToTop Button -->
    <button aria-label="Scroll to top button" class="bloc-button btn btn-d scrollToTop"
            onclick="scrollToTarget('1',this)">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
            <path class="scroll-to-top-btn-icon" d="M30,22.656l-14-13-14,13"/>
        </svg>
    </button>
</div>

<script src="../js/bootstrap.bundle.min.js?3058"></script>
<script src="../js/blocs.min.js?6353"></script>
<script src="../js/lazysizes.min.js" defer></script>
<script>
    // Global variables
    let currentSprintId = null;

    // Function to handle adding a new sprint
    window.handleAddSprintClick = function (event) {
        event.preventDefault();
        setSprintFormMode('add');
    }


    // Function to set sprint form mode (add or edit)
    function setSprintFormMode(mode, sprint = null) {
        console.log("Setting sprint form mode:", mode);
        const form = document.getElementById('sprintForm');
        const buttons = document.querySelector('.form-buttons');
        buttons.innerHTML = '';

        if (mode === 'edit' && sprint) {
            fillSprintFormWithData(sprint);
            buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateSprint('${sprint.key}')">Update</button>
        `;
            currentSprintId = sprint.key;
        } else if (mode === 'add') {
            form.reset();
            setDefaultSprintFormValues();
            buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSprint()">Save Sprint</button>
        `;
            currentSprintId = null;
        }

        toggleSprintPopup();
    }

    // Function to fill sprint form with data
    function fillSprintFormWithData(sprint) {
        const form = document.getElementById('sprintForm');
        form.elements['sprintTitle'].value = sprint.title || '';
        form.elements['sprintDescription'].value = sprint.description || '';
        form.elements['productOwner'].value = sprint.productOwner || '';
        form.elements['scrumMaster'].value = sprint.scrumMaster || '';
        form.elements['sprintStartTime'].value = sprint.startTime || '';
        form.elements['sprintEndTime'].value = sprint.endTime || '';

        const statusContainer = document.getElementById('sprintStatus');
        statusContainer.innerHTML = `<div class="pill-button status-${sprint.status.toLowerCase().replace(/ /g, '-')}">${sprint.status}</div>`;
    }

    // Function to set default sprint form values
    function setDefaultSprintFormValues() {
        const form = document.getElementById('sprintForm');
        form.elements['sprintStatus'].value = 'Not started';
    }

    // Function to toggle sprint popup
    function toggleSprintPopup() {
        console.log("Toggling sprint popup");
        const popup = document.getElementById('sprintFormPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.toggle('open');
        overlay.classList.toggle('open');
        console.log("Popup visibility:", popup.classList.contains('open'));
    }

    // Function to save a new sprint
    function saveSprint() {
        const sprintData = getSprintFormData();
        if (validateSprintData(sprintData)) {
            sendFormDataToFirebase(sprintData);
            toggleSprintPopup();
        }
    }

    // Function to get sprint form data
    function getSprintFormData() {
        const form = document.getElementById('sprintForm');
        return {
            title: form.elements['sprintTitle'].value,
            description: form.elements['sprintDescription'].value,
            productOwner: form.elements['productOwner'].value,
            scrumMaster: form.elements['scrumMaster'].value,
            startTime: form.elements['sprintStartTime'].value,
            endTime: form.elements['sprintEndTime'].value,
            status: calculateSprintStatus(form.elements['sprintStartTime'].value, form.elements['sprintEndTime'].value)
        };
    }


    // Function to validate sprint data
    function validateSprintData(data) {
        for (let key in data) {
            if (data[key] === '') {
                alert(`Please fill in the ${key} field.`);
                return false;
            }
        }
        if (new Date(data.startTime) >= new Date(data.endTime)) {
            alert('End time must be after start time.');
            return false;
        }
        return true;
    }

    // Function to calculate sprint status based on time
    function calculateSprintStatus(startTime, endTime) {
        const now = new Date();
        const start = new Date(startTime);
        const end = new Date(endTime);

        if (now < start) return 'Not started';
        if (now >= start && now <= end) return 'In progress';
        return 'Done';
    }

    // Function to update a sprint
    function updateSprint(sprintId) {
        const sprintData = getSprintFormData();
        if (validateSprintData(sprintData)) {
            updateSprintInFirebase(sprintId, sprintData);
            toggleSprintPopup();
        }
    }

    // Function to render sprint board
    function renderSprintBoard(data) {
        const container = document.getElementById('sprintCardsContainer');
        if (!container) {
            console.error('Sprint cards container not found');
            return; // Exit the function if the container is not found
        }

        container.innerHTML = '';

        if (!data || Object.keys(data).length === 0) {
            const noDataMessage = document.createElement('p');
            noDataMessage.textContent = 'No sprints added yet.';
            noDataMessage.style.textAlign = 'center';
            noDataMessage.style.padding = '20px';
            container.appendChild(noDataMessage);
        } else {
            Object.entries(data).forEach(([key, sprint]) => {
                const card = createSprintCard(sprint, key);
                container.appendChild(card);
            });
        }
    }

    // Function to create a sprint card
    function createSprintCard(sprint, key) {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.setAttribute('data-sprint-id', key);

        const statusPill = `<div class="pill-button status-${sprint.status.toLowerCase().replace(/ /g, '-')}">${sprint.status}</div>`;

        card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mg-clear">${sprint.title}</h3>
            <div>
                <button class="btn btn-primary sprint-backlog-button" data-sprint-id="${key}">Sprint Backlog</button>
                <div class="dropdown d-inline-block">
                    <button class="btn btn-link dropdown-toggle three-dot-menu" type="button" id="dropdownMenu-${key}" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${key}">
                        <li><a class="dropdown-item text-danger delete-sprint" href="#" data-sprint-id="${key}">Delete</a></li>
                        <li><a class="dropdown-item text-primary edit-sprint" href="#" data-sprint-id="${key}">Edit</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            <p>${sprint.description}</p>
            <p>Product Owner: ${sprint.productOwner}</p>
            <p>Scrum Master: ${sprint.scrumMaster}</p>
            <p>Status: ${statusPill}</p>
            <p>Start: ${new Date(sprint.startTime).toLocaleString()}</p>
            <p>End: ${new Date(sprint.endTime).toLocaleString()}</p>
        </div>
    `;

        card.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown') && !event.target.classList.contains('sprint-backlog-button')) {
                openSprintViewMode(sprint, key);
            }
        });

        return card;
    }


    function openSprintViewMode(sprint, key) {
        const form = document.getElementById('sprintForm');

        // Fill in the form fields
        form.elements['sprintTitle'].value = sprint.title || '';
        form.elements['sprintDescription'].value = sprint.description || '';
        form.elements['productOwner'].value = sprint.productOwner || '';
        form.elements['scrumMaster'].value = sprint.scrumMaster || '';
        form.elements['sprintStartTime'].value = sprint.startTime || '';
        form.elements['sprintEndTime'].value = sprint.endTime || '';
        const statusElement = document.getElementById('sprintStatus');
        if (statusElement) {
            statusElement.innerHTML = `<div class="pill-button status-${sprint.status.toLowerCase().replace(/ /g, '-')}">${sprint.status}</div>`;
        } else {
            console.error('Sprint status element not found');
        }

        // Disable all form fields
        Array.from(form.elements).forEach(el => el.disabled = true);

        // Change buttons: Only "Back"
        const buttons = document.querySelector('.form-buttons');
        buttons.innerHTML = '<button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Back</button>';

        // Open popup
        toggleSprintPopup();
    }


    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {

        // Event delegation for delete and edit buttons
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-sprint')) {
                event.preventDefault();
                const sprintId = event.target.getAttribute('data-sprint-id');
                showDeleteConfirmation(sprintId);
            } else if (event.target.classList.contains('edit-sprint')) {
                event.preventDefault();
                const sprintId = event.target.getAttribute('data-sprint-id');
                editSprint(sprintId);
            } else if (event.target.getAttribute('data-task-id')) {
                event.preventDefault();
                editTask(taskId)
            }
        });

        // Close popup when clicking outside
        document.getElementById('overlay').addEventListener('click', toggleSprintPopup);

        // Initial fetch of sprint board data
        fetchSprintBoard();

    });

    ;




    // Function to render sprint board
    window.renderSprintBoard = function (data) {
        const container = document.getElementById('sprintCardsContainer');
        container.innerHTML = '';

        if (!data || Object.keys(data).length === 0) {
            const noDataMessage = document.createElement('p');
            noDataMessage.textContent = 'No sprints added yet.';
            noDataMessage.style.textAlign = 'center';
            noDataMessage.style.padding = '20px';
            container.appendChild(noDataMessage);
        } else {
            Object.entries(data).forEach(([key, sprint]) => {
                const card = createSprintCard(sprint, key);
                container.appendChild(card);
            });
        }
    }


    // Function to show delete confirmation
    function showDeleteConfirmation(sprintId) {
        const popup = document.getElementById('delete-confirmation-popup');
        popup.style.display = 'block';
        document.getElementById('overlay').classList.add('open');

        // Set up event listeners for delete confirmation
        document.querySelector('#delete-confirmation-popup .btn-secondary').onclick = hideDeleteConfirmation;
        document.querySelector('#delete-confirmation-popup .btn-danger').onclick = () => {
            deleteSprint(sprintId);
            hideDeleteConfirmation();
        };
    }

    window.updateSprint = async function (sprintId) {
        try {
            const sprintData = getSprintFormData();
            await update(ref(database, `sprintboard/${sprintId}`), sprintData);
            console.log('Sprint updated successfully');
            toggleSprintPopup();
        } catch (error) {
            console.error("Error updating sprint:", error);
        }
    }

    // Function to create a sprint card
    function createSprintCard(sprint, key) {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.setAttribute('data-sprint-id', key);

        const statusPill = `<div class="pill-button status-${sprint.status.toLowerCase().replace(/ /g, '-')}">${sprint.status}</div>`;

        card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mg-clear">${sprint.title}</h3>
            <div>
                <button class="sprint-backlog-button btn-secondary btn " data-sprint-id="${key}">Sprint Backlog</button>
                <div class="dropdown d-inline-block">
                <div class="dropdown">
                    <button class="btn btn-link three-dot-menu" type="button" id="dropdownMenu-${key}" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${key}">
                        <li><a class="dropdown-item text-danger delete-sprint" href="#" data-sprint-id="${key}">Delete</a></li>
                        <li><a class="dropdown-item text-primary edit-sprint" href="#" data-sprint-id="${key}">Edit</a></li>
                    </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <p>${sprint.description}</p>
            <p>Product Owner: ${sprint.productOwner}</p>
            <p>Scrum Master: ${sprint.scrumMaster}</p>
            <p>Status: ${statusPill}</p>
            <p>Start: ${new Date(sprint.startTime).toLocaleString()}</p>
            <p>End: ${new Date(sprint.endTime).toLocaleString()}</p>
        </div>
    `;

        card.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown') && !event.target.classList.contains('sprint-backlog-button')) {
                openSprintViewMode(sprint, key);
            }
        });

        return card;
    }

    // Function to hide delete confirmation
    function hideDeleteConfirmation() {
        document.getElementById('delete-confirmation-popup').style.display = 'none';
        document.getElementById('overlay').classList.remove('open');
    }

    // Function to calculate sprint status based on time
    function calculateSprintStatus(startTime, endTime) {
        const now = new Date();
        const start = new Date(startTime);
        const end = new Date(endTime);

        if (now < start) return 'Not started';
        if (now >= start && now <= end) return 'In progress';
        return 'Completed';
    }

    // Function to edit a sprint
    function editSprint(sprintId) {
        console.log("Editing sprint with ID:", sprintId);
        toggleSprintPopup();
        getSprintFromFirebase(sprintId).then(sprint => {
            if (sprint) {
                sprint.key = sprintId;
                setSprintFormMode('edit', sprint);
            } else {
                console.log("Sprint not found");
            }
        }).catch(console.error);
    }


    // Function to periodically update sprint statuses
    function updateAllSprintStatuses() {
        getAllSprintsFromFirebase().then(sprints => {
            if (sprints) {
                Object.entries(sprints).forEach(([sprintId, sprint]) => {
                    const newStatus = calculateSprintStatus(sprint.startTime, sprint.endTime);
                    if (newStatus !== sprint.status) {
                        updateSprintStatusInFirebase(sprintId, newStatus);
                    }
                });
            }
        }).catch(console.error);
    }

    // Set interval to update sprint statuses every minute
    setInterval(updateAllSprintStatuses, 60000);

</script>
<script type="module">
    // Import necessary modules
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
        getDatabase,
        ref,
        get,
        set,
        push,
        update,
        remove,
        onValue
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Firebase configuration (same as Product Backlog)
    const firebaseConfig = {
        apiKey: "AIzaSyDicFj4DUKZo2iYXZN8tUE2FcMLqmQ_cgU",
        authDomain: "izuck-digital.firebaseapp.com",
        databaseURL: "https://izuck-digital-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "izuck-digital",
        storageBucket: "izuck-digital.appspot.com",
        messagingSenderId: "875586622876",
        appId: "1:875586622876:web:dab65a8d81690d7a18e459",
        measurementId: "G-1YRPZNH521"
    };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const sprintBoardRef = ref(database, 'sprintboard');

    window.getSprintFromFirebase = function (sprintId) {
        return get(ref(database, `sprintboard/${sprintId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const sprintData = snapshot.val();
                    sprintData.key = sprintId;
                    return sprintData;
                } else {
                    return null;
                }
            })
            .catch((error) => {
                console.error("Error fetching sprint:", error);
                return null;
            });
    }

    // Function to fetch sprint board data
    window.fetchSprintBoard = async function () {
        try {
            const snapshot = await get(sprintBoardRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                window.renderSprintBoard(data);
            } else {
                console.log("No sprint data available");
            }
        } catch (error) {
            console.error("Error fetching sprint board:", error);
        }
    }


    window.sendFormDataToFirebase = async function () {
        try {
            const formData = getFormData();
            if (Object.values(formData).some(value => value === '')) {
                alert('Please fill in all fields');
                return;
            }

            await push(productBacklogRef, formData);
            console.log('Data saved successfully');
            togglePopup();
        } catch (error) {
            console.error("Error sending form data:", error);
        }
    }
    // Function to handle adding a new sprint
    window.handleAddSprintClick = function (event) {
        event.preventDefault();
        setSprintFormMode('add');
    }

    function exitSprintBacklogMode() {
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
        <div class="bloc l-bloc" id="bloc-1">
            <div class="container bloc-lg">
                <div class="row align-items-center">
                    <div class="col">
                        <div id="sprintCardsContainer" class="sprint-cards-container">
                            <!-- Sprint cards will be dynamically added here -->
                        </div>
                        <div class="form-group mb-3">
                            <button class="btn btn-lg btn-9-style btn-c-7647" id="addSprintButton">
                                <span class="fa fa-plus"></span> Add Sprint
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Re-attach event listener for add sprint button
        document.getElementById('addSprintButton').addEventListener('click', handleAddSprintClick);

        fetchSprintBoard(); // This will now render the sprint board correctly
    }


function enterSprintBacklogMode(sprintId, sprintTitle) {
    currentSprintTasks = []; // Reset the current sprint tasks
    const mainContent = document.querySelector('.main-content');
    mainContent.innerHTML = `
        <div class="main-container">
            <div class="tasks-container">
                <h2 data-sprint-id="${sprintId}">${sprintTitle}</h2>
                <div id="sprintTasks" class="sprint-tasks"></div>
            </div>
            <div class="tasks-container">
                <h2>Backlog Tasks</h2>
                <div id="backlogTasks" class="backlog-tasks"></div>
            </div>
        </div>
        <div class="sprint-backlog-buttons">
            <button id="cancelSprintBacklog" class="btn btn-secondary">Cancel</button>
            <button id="saveSprintBacklog" class="btn btn-primary">Save Changes</button>
        </div>
    `;
    fetchSprintTasks(sprintId).then(() => fetchBacklogTasks());
}

async function fetchBacklogTasks() {
    const backlogContainer = document.getElementById('backlogTasks');
    if (!backlogContainer) {
        console.error('Backlog container not found');
        return;
    }
    const db = getDatabase();
    const backlogRef = ref(db, 'productBacklog');
    const snapshot = await get(backlogRef);
    if (snapshot.exists()) {
        const backlogTasks = snapshot.val();
        backlogContainer.innerHTML = '';
        Object.entries(backlogTasks).forEach(([key, task]) => {
            if (!currentSprintTasks.includes(key)) {
                const taskCard = createTaskCard(key, task);
                backlogContainer.appendChild(taskCard);
            }
        });
    }
    initDragAndDrop();
}

async function getTasksFromDatabase() {
    try {
        const db = getDatabase();
        const backlogRef = ref(db, 'productBacklog'); // Adjust the path as necessary
        const snapshot = await get(backlogRef);
        if (snapshot.exists()) {
            const tasksObject = snapshot.val();
            // Convert object to array if necessary
            return Object.entries(tasksObject).map(([id, task]) => ({ id, ...task }));
        } else {
            console.log("No tasks found in the backlog.");
            return [];
        }
    } catch (error) {
        console.error("Error fetching tasks from database:", error);
        return [];
    }
}


    // Function to set sprint form mode
    function setSprintFormMode(mode, sprint = null) {
        const form = document.getElementById('sprintForm');
        const buttons = document.querySelector('.form-buttons');
        buttons.innerHTML = '';

        if (mode === 'edit' && sprint) {
            fillSprintFormWithData(sprint);
            buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateSprint('${sprint.key}')">Update</button>
        `;
        } else if (mode === 'add') {
            form.reset();
            setDefaultSprintFormValues();
            buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="toggleSprintPopup()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSprint()">Save Sprint</button>
        `;
        }

        toggleSprintPopup();
    }

    // Function to fill sprint form with data
    function fillSprintFormWithData(sprint) {
        const form = document.getElementById('sprintForm');
        form.elements['sprintTitle'].value = sprint.title || '';
        form.elements['sprintDescription'].value = sprint.description || '';
        form.elements['productOwner'].value = sprint.productOwner || '';
        form.elements['scrumMaster'].value = sprint.scrumMaster || '';
        form.elements['sprintStartTime'].value = sprint.startTime || '';
        form.elements['sprintEndTime'].value = sprint.endTime || '';

        // Update the status display
        const statusContainer = form.querySelector('#sprintStatus');
        statusContainer.innerHTML = `<div class="pill-button status-${sprint.status.toLowerCase().replace(/ /g, '-')}">${sprint.status}</div>`;
    }

    // Function to set default sprint form values
    function setDefaultSprintFormValues() {
        const statusContainer = document.getElementById('sprintStatus');
        statusContainer.innerHTML = '<div class="pill-button status-not-started">Not started</div>';
    }

    // Function to toggle sprint popup
    window.toggleSprintPopup = function () {
        const popup = document.getElementById('sprintFormPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.toggle('open');
        overlay.classList.toggle('open');

        if (!popup.classList.contains('open')) {
            // Reset form state

            const form = document.getElementById('sprintForm');
            form.reset();
            Array.from(form.elements).forEach(el => el.disabled = false);
        }
    }

    // Function to save a new sprint
    window.saveSprint = async function () {
        try {
            const sprintData = getSprintFormData();
            if (Object.values(sprintData).some(value => value === '')) {
                alert('Please fill in all fields');
                return;
            }

            await push(sprintBoardRef, sprintData);
            console.log('Sprint saved successfully');
            toggleSprintPopup();
        } catch (error) {
            console.error("Error saving sprint:", error);
        }
    }

    // Function to get sprint form data
    function getSprintFormData() {
        const form = document.getElementById('sprintForm');
        const statusElement = document.querySelector('#sprintStatus .pill-button');
        return {
            title: form.elements['sprintTitle'].value,
            description: form.elements['sprintDescription'].value,
            productOwner: form.elements['productOwner'].value,
            scrumMaster: form.elements['scrumMaster'].value,
            startTime: form.elements['sprintStartTime'].value,
            endTime: form.elements['sprintEndTime'].value,
            status: statusElement ? statusElement.textContent : 'Not started'
        };
    }


    // Function to update sprint status
    function updateSprintStatus(sprintId, startTime, endTime) {
        const status = calculateSprintStatus(startTime, endTime);
        update(ref(database, `sprintboard/${sprintId}`), {status: status});
    }

    // Function to update a sprint


    // Function to delete a sprint
    window.deleteSprint = async function (sprintId) {
        try {
            await remove(ref(database, `sprintboard/${sprintId}`));
            console.log("Sprint deleted successfully");
        } catch (error) {
            console.error("Error deleting sprint:", error);
        }
    }

    // Set up real-time listener for sprint board
    function setupSprintRealtimeListener() {
        onValue(sprintBoardRef, (snapshot) => {
            const data = snapshot.val() || {};
            window.renderSprintBoard(data);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('addSprintButton').addEventListener('click', handleAddSprintClick);
    });

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        setupSprintRealtimeListener();
        document.querySelector('.btn-lg.btn-9-style').addEventListener('click', handleAddSprintClick);
        initDragAndDrop();
    });

    // Event delegation for delete and edit buttons
    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('edit-sprint')) {
            event.preventDefault();
            const sprintId = event.target.getAttribute('data-sprint-id');
            get(ref(database, `sprintboard/${sprintId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const sprint = snapshot.val();
                    sprint.key = sprintId;
                    setSprintFormMode('edit', sprint);
                }
            }).catch(console.error);
        }
    });

    document.addEventListener('click', (event) => {
        const card = event.target.closest('.card');
        if (card && !event.target.closest('.dropdown, .btn-link')) {
            const sprintId = card.getAttribute('data-sprint-id');
            if (sprintId) {
                getSprintFromFirebase(sprintId).then((sprint) => {
                    if (sprint) {
                        sprint.key = sprintId;
                        openSprintViewMode(sprint, sprintId);
                    }
                }).catch(console.error);
            }
        }
    });

    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('sprint-backlog-button')) {
            const sprintId = event.target.getAttribute('data-sprint-id');
            const sprintTitle = event.target.closest('.card').querySelector('h3').textContent;
            enterSprintBacklogMode(sprintId, sprintTitle);
        }
    })

    // Function to periodically update sprint statuses
    function updateAllSprintStatuses() {
        get(sprintBoardRef).then((snapshot) => {
            if (snapshot.exists()) {
                const sprints = snapshot.val();
                Object.entries(sprints).forEach(([sprintId, sprint]) => {
                    updateSprintStatus(sprintId, sprint.startTime, sprint.endTime);
                });
            }
        }).catch(console.error);
    }

    async function fetchTaskDetails(taskId) {
        const taskRef = ref(database, `productBacklog/${taskId}`);
        const snapshot = await get(taskRef);
        return snapshot.exists() ? snapshot.val() : null;
    }

async function saveSprintBacklog() {
    const sprintTasks = Array.from(document.querySelectorAll('#sprintTasks .task-card'))
        .map(card => card.getAttribute('data-task-id'));
    const sprintIdElement = document.querySelector('.tasks-container h2');
    const sprintId = sprintIdElement.getAttribute('data-sprint-id');
    if (!sprintId) {
        console.error('Sprint ID not found');
        return;
    }
    const sprintRef = ref(database, `sprintboard/${sprintId}/sprintTasks`);
    try {
        await set(sprintRef, sprintTasks);
        console.log('Sprint tasks saved successfully');
        // Do not remove tasks from backlog
        exitSprintBacklogMode();
    } catch (error) {
        console.error('Error saving sprint tasks:', error);
    }
}

    window.getAllSprintsFromFirebase = async function () {
        try {
            const snapshot = await get(sprintBoardRef);
            return snapshot.val();
        } catch (error) {
            console.error("Error fetching all sprints:", error);
            return null;
        }
    }

    document.addEventListener('click', (event) => {
        if (event.target.id === 'saveSprintBacklog') {
            saveSprintBacklog();
        } else if (event.target.id === 'cancelSprintBacklog') {
            exitSprintBacklogMode();
        }
    });

let currentSprintTasks = [];

async function fetchSprintTasks(sprintId) {
    const sprintContainer = document.getElementById('sprintTasks');
    if (!sprintContainer) {
        console.error('Sprint tasks container not found');
        return;
    }
    const db = getDatabase();
    const sprintRef = ref(db, `sprintboard/${sprintId}/sprintTasks`);
    const snapshot = await get(sprintRef);
    if (snapshot.exists()) {
        const sprintTasks = snapshot.val();
        currentSprintTasks = sprintTasks; // Store the current sprint tasks
        sprintContainer.innerHTML = '';
        for (const taskId of sprintTasks) {
            const task = await fetchTaskDetails(taskId);
            if (task) {
                const taskCard = createTaskCard(taskId, task);
                sprintContainer.appendChild(taskCard);
            }
        }
    }
    initDragAndDrop();
}

function initDragAndDrop() {
    const containers = document.querySelectorAll('#sprintTasks, #backlogTasks');

    containers.forEach(container => {
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable && draggable !== afterElement) {
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            }
        });

        container.addEventListener('dragenter', e => {
            e.preventDefault();
            container.classList.add('drag-over');
        });

        container.addEventListener('dragleave', () => {
            container.classList.remove('drag-over');
        });

        container.addEventListener('drop', e => {
            e.preventDefault();
            container.classList.remove('drag-over');
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                // Remove the task from its original container
                draggable.parentNode.removeChild(draggable);
                // Add it to the new container
                container.appendChild(draggable);
                draggable.classList.remove('dragging');
                updateTaskStatus(draggable.getAttribute('data-task-id'), container.id);
            }
        });
    });

    const draggables = document.querySelectorAll('.task-card');
    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => {
            draggable.classList.add('dragging');
        });
        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateTaskStatus(taskId, newContainerId) {
    const isSprintTask = newContainerId === 'sprintTasks';
    console.log(`Updating task ${taskId} status to ${isSprintTask ? 'Sprint' : 'Backlog'}`);

    const db = getDatabase();
    const sprintId = document.querySelector('.tasks-container h2').getAttribute('data-sprint-id');

    if (isSprintTask) {
        // Add to sprint tasks
        if (!currentSprintTasks.includes(taskId)) {
            currentSprintTasks.push(taskId);
            const sprintTasksRef = ref(db, `sprintboard/${sprintId}/sprintTasks`);
            set(sprintTasksRef, currentSprintTasks);
        }
        // Hide from backlog
        const backlogTask = document.querySelector(`#backlogTasks [data-task-id="${taskId}"]`);
        if (backlogTask) backlogTask.remove();
    } else {
        // Remove from sprint tasks
        currentSprintTasks = currentSprintTasks.filter(id => id !== taskId);
        const sprintTasksRef = ref(db, `sprintboard/${sprintId}/sprintTasks`);
        set(sprintTasksRef, currentSprintTasks);
        // Show in backlog if not already there
        const backlogContainer = document.getElementById('backlogTasks');
        if (!backlogContainer.querySelector(`[data-task-id="${taskId}"]`)) {
            fetchTaskDetails(taskId).then(task => {
                if (task) {
                    const taskCard = createTaskCard(taskId, task);
                    backlogContainer.appendChild(taskCard);
                }
            });
        }
    }
}



function createTaskCard(key, task) {
    const card = document.createElement('div');
    card.className = 'task-card';
    card.setAttribute('draggable', 'true');
    card.setAttribute('data-task-id', key);
    card.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mg-clear mb-0">${task.title}</h4>
            <div>
                <div class="dropdown d-inline-block edit-task">
                    <button class="btn btn-link three-dot-menu" type="button" id="dropdownMenu-${key}" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${key}">
                        <li><a class="dropdown-item text-primary edit-task" href="#" data-task-id="${key}">Edit</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <p>${task.description}</p>
        
    `
    return card;
}

document.addEventListener('DOMContentLoaded', function() {
    initDragAndDrop();
});

// Call this function when the DOM is loaded
document.addEventListener('DOMContentLoaded', initDragAndDrop);

    document.addEventListener('click', (event) => {
        const card = event.target.closest('.card');
        if (card && !event.target.closest('.dropdown, .btn-link')) {
            const sprintId = card.getAttribute('data-sprint-id');
            if (sprintId) {
                getSprintFromFirebase(sprintId).then((sprint) => {
                    if (sprint) {
                        sprint.key = sprintId;
                        openSprintViewMode(sprint, sprintId);
                    }
                }).catch(console.error);
            }
        }
    });

    let currentData;

    function fetchSprintBoard() {
        get(ref(database, 'sprintboard')).then((snapshot) => {
            if (snapshot.exists()) {
                const currentData = snapshot.val();
                console.log('Fetched Data:', currentData); // Debugging line
                renderSprintBoard(currentData);
            } else {
                console.log("No data available");
                renderSprintBoard({}); // Render an empty board
            }
        }).catch((error) => {
            console.error("Error fetching sprint board:", error);
            renderSprintBoard({}); // Render an empty board in case of error
        });
    }

    // Set interval to update sprint statuses every minute
    setInterval(updateAllSprintStatuses, 60000);

    // Initial fetch of sprint board data
    fetchSprintBoard();

    // Function to clear all sprints (DEBUGGING ONLY)
    function clearAllSprints() {
        const database = getDatabase();
        const sprintBoardRef = ref(database, 'sprintboard');
        remove(sprintBoardRef)
            .then(() => {
                console.log("All sprints cleared successfully.");
            })
            .catch((error) => {
                console.error("Error clearing sprints:", error);
            });
    }


    // Expose the function to the global scope for console access
    window.clearAllSprints = clearAllSprints;
</script>
</body>
</html>
