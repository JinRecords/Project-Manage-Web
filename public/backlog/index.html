<!doctype html>
<html lang="en">
<head>
    <!-- STYLE FOR THIS PAGE IS NOW MOVED TO public/css/backlogStyle.css -->
    <link rel="stylesheet" type="text/css" href="../css/backlogStyle.css">
    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="robots" content="index, follow">
    <link rel="shortcut icon" type="image/jpeg" href="../favicon.jpeg">

    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css?2917">
    <link rel="stylesheet" type="text/css" href="../style.css?4034">
    <link rel="stylesheet" type="text/css" href="../css/animate.min.css?9837">
    <link rel="stylesheet" type="text/css" href="../css/feather.min.css">
    <link rel="stylesheet" type="text/css" href="../css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../css/ionicons.min.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins:100,500,700,40&display=swap&subset=latin,latin-ext'
          rel='stylesheet' type='text/css'>
    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {getDatabase, ref, push} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    </script>
    <title>Backlog</title>
<link rel="preload" href="../css/backlogStyle.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="../css/backlogStyle.css"></noscript>
</head>
<body data-clean-url="true">

<!-- Preloader -->
<div id="page-loading-blocs-notifaction" class="page-preloader"></div>

<!-- Main container -->
<div class="page-container">

    <!-- Logo Sidebar -->
    <div class="logo-sidebar">
        <div class="icon-container">
            <picture>
                <source type="image/webp" srcset="../img/lazyload-ph.png" data-srcset="../img/favicon.webp">
                <img src="../img/lazyload-ph.png" data-src="../img/favicon.jpeg" class="lazyload" alt="favicon.jpeg">
            </picture>
            <div class="text-center mt-lg-4">
                <span class="icon-md feather-icon icon-content-left icon-672"></span>
            </div>
        </div>
    </div>

    <!-- Links Sidebar -->
    <div class="links-sidebar">
        <div class="button-container">
            <a href="../backlog/index.html"
               class="btn btn-lg mb-lg-3 btn-c-672 btn-style ps-lg-0 btn-clean-clicked product-backlog-btn">
                <span class="icon-spacer fa fa-laptop icon-7647 me-lg-3"></span>Product Backlog
            </a>
            <a href="../sprintboard/index.html"
               class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-running icon-7097 icon-md me-lg-3"></span>Sprint Board
            </a>
            <a href="../" class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3">
                <span class="icon-spacer ion ion-android-people icon-md me-lg-3"></span>Team members
            </a>
        </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- bloc-1 -->
        <div class="bloc l-bloc" id="bloc-1">
            <div class="container bloc-lg">
                <div class="row align-items-center">
                    <div class="col-auto ml-auto">
                        <button id="sortButton" class="btn btn-secondary"><i class="fas fa-sort"></i></button>
                        <button id="filterButton" class="btn btn-secondary"><i class="fas fa-filter"></i></button>
                    </div>
                    <div class="col">
                        <div class="form-group mb-3">
                            <button class="btn btn-lg btn-8-style btn-c-7647" onclick="handleAddButtonClick(event)">
                                <span class="fa fa-plus"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- bloc-1 END -->

    <!-- Delete Confirmation Popup -->
    <div id="delete-confirmation-popup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Confirm Deletion</h4>
            <p>Are you sure you want to delete this item?</p>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Popup Form -->
    <div id="popupForm" class="popup-form">
        <form id="backlogForm">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" placeholder="Enter Title">
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" id="description" rows="3" placeholder="Enter description"></textarea>
                <hr class="grey-line-break">
            </div>
            <div class="form-group">
                <label for="tags">Tags:</label>
                <div class="tags-container" id="popup-tags-container"></div>
                <button type="button" class="add-tag-button" id="add-tag-button" onclick="showTagSelectionPopup()">+
                </button>
            </div>
            <div class="form-group">
                <label for="assignee">Assignee:</label>
                <select class="form-control" id="assignee"
                        style="width: 150px; display: inline-block; margin-left: 10px;">
                    <option>test1</option>
                    <option>test2</option>
                    <option>test3</option>
                </select>
            </div>
            <div class="form-group">
                <label for="priority">Priority:</label>
                <button type="button" class="pill-button priority-low" onclick="setPriority('Low')">Low</button>
                <button type="button" class="pill-button priority-medium" onclick="setPriority('Medium')">Medium
                </button>
                <button type="button" class="pill-button priority-important" onclick="setPriority('Important')">
                    Important
                </button>
                <button type="button" class="pill-button priority-urgent" onclick="setPriority('Urgent')">
                    Urgent
                </button>
                <input type="hidden" id="priority-input" value="">
            </div>
            <div class="form-group">
                <label for="status">Status:</label>
                <button type="button" class="pill-button status-not-started" onclick="setStatus('Not started')">Not
                    started
                </button>
                <button type="button" class="pill-button status-in-progress" onclick="setStatus('In progress')">In
                    progress
                </button>
                <button type="button" class="pill-button status-done" onclick="setStatus('Done')">Done</button>
                <input type="hidden" id="status-input" value="Not started">
            </div>
            <div class="form-group">
                <label for="stage">Stage:</label>
                <button type="button" class="pill-button stage-planning" onclick="setStage('Planning')">Planning
                </button>
                <button type="button" class="pill-button stage-development" onclick="setStage('Development')">
                    Development
                </button>
                <button type="button" class="pill-button stage-testing" onclick="setStage('Testing')">Testing</button>
                <button type="button" class="pill-button stage-integration" onclick="setStage('Integration')">
                    Integration
                </button>
                <input type="hidden" id="stage-input" value="">
            </div>
            <div class="form-group">
                <label for="storypoint">Storypoint:</label>
                <select class="form-control" id="storypoint"
                        style="width: 150px; display: inline-block; margin-left: 10px;">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                    <option>10</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" class="form-control" id="timeCreated" readonly>
            </div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timeline-events"></div>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="togglePopup()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleSaveChanges()">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Tag Selection Popup -->
    <div id="tag-selection-popup" class="tag-selection-popup">
        <h4>Select Tags</h4>
        <div class="tag-selection" id="tag-selection"></div>
        <div class="close-button-container">
            <button class="btn btn-secondary" onclick="hideTagSelectionPopup()">Close</button>
        </div>
    </div>

    <!-- Sorting Popup -->
    <div id="sorting-popup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Sort By</h4>
            <div id="sorting-options">
                <div class="sorting-option">
                    <label for="sort-default">Default
                        <input type="radio" id="sort-default" name="sort-option" value="default" checked>
                    </label>
                </div>
                <div class="sorting-option">
                    <label for="sort-oldest-recent">Oldest → Recent
                        <input type="radio" id="sort-oldest-recent" name="sort-option" value="oldest-recent">
                    </label>
                </div>
                <div class="sorting-option">
                    <label for="sort-recent-oldest">Recent → Oldest
                        <input type="radio" id="sort-recent-oldest" name="sort-option" value="recent-oldest">
                    </label>
                </div>
                <div class="sorting-option">
                    <label for="sort-low-important">Low → Important
                        <input type="radio" id="sort-low-important" name="sort-option" value="low-important">
                    </label>
                </div>
                <div class="sorting-option">
                    <label for="sort-important-low">Important → Low
                        <input type="radio" id="sort-important-low" name="sort-option" value="important-low">
                    </label>
                </div>
            </div>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideSortingPopup()">Cancel</button>
                <button class="btn btn-primary" onclick="applySorting()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Filter Popup -->
    <div id="filter-popup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Filter By</h4>
            <div id="filter-option" class="button-container">
                <button class="pill-button" style="background-color: #FFC0CB;"
                        onclick="toggleFilterTagSelection(this, 'UI')">UI
                </button>
                <button class="pill-button" style="background-color: #FFD7BE;"
                        onclick="toggleFilterTagSelection(this, 'UX')">UX
                </button>
                <button class="pill-button" style="background-color: #F7DC6F;"
                        onclick="toggleFilterTagSelection(this, 'Frontend')">Frontend
                </button>
                <button class="pill-button" style="background-color: #C6F4D6;"
                        onclick="toggleFilterTagSelection(this, 'Backend')">Backend
                </button>
                <button class="pill-button" style="background-color: #9ED2C0;"
                        onclick="toggleFilterTagSelection(this, 'Framework')">Framework
                </button>
                <button class="pill-button" style="background-color: #8DB8CB;"
                        onclick="toggleFilterTagSelection(this, 'Testing')">Testing
                </button>
                <button class="pill-button" style="background-color: #9F9CE9;"
                        onclick="toggleFilterTagSelection(this, 'Database')">Database
                </button>
                <button class="pill-button" style="background-color: #BE8DE4;"
                        onclick="toggleFilterTagSelection(this, 'API')">API
                </button>
            </div>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideFilterPopup()">Cancel</button>
                <button class="btn btn-primary" onclick="applyFilter()">Apply</button>
            </div>
        </div>
    </div>

    <!-- ScrollToTop Button -->
    <button aria-label="Scroll to top button" class="bloc-button btn btn-d scrollToTop"
            onclick="scrollToTarget('1',this)">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
            <path class="scroll-to-top-btn-icon" d="M30,22.656l-14-13-14,13"/>
        </svg>
    </button>
    <!-- ScrollToTop Button END-->
</div>


<!-- Additional JS -->
<script src="../js/bootstrap.bundle.min.js?3058"></script>
<script src="../js/blocs.min.js?6353"></script>
<script src="../js/lazysizes.min.js" defer></script>

<script>
    let tags = [], priority = '', sprint = '', status = 'Not started', stage = '';
    const availableTags = ['UI', 'UX', 'Frontend', 'Backend', 'Framework', 'Testing', 'Database', 'API'];
    const tagColors = ['#FFC0CB', '#FFD7BE', '#F7DC6F', '#C6F4D6', '#9ED2C0', '#8DB8CB', '#9F9CE9', '#BE8DE4'];
    let currentSortOption = 'default', currentFilterOption = [];
    window.tags = [];

    function fetchProductBacklog() {
        get(ref(database, 'productBacklog')).then((snapshot) => {
            if (snapshot.exists()) {
                currentData = snapshot.val();
                console.log('Fetched Data:', currentData); // Debugging line
                renderProductBacklog(currentData);
            } else {
                console.log("No data available");
            }
        }).catch(console.error);
    }

    function renderProductBacklog(data) {
        const container = document.querySelector('.col .form-group.mb-3');
        container.innerHTML = ''; // Clear the container

        if (!data || Object.keys(data).length === 0) {
            const noDataMessage = document.createElement('p');
            noDataMessage.textContent = 'No items in the product backlog.';
            noDataMessage.style.textAlign = 'center';
            noDataMessage.style.padding = '20px';
            container.appendChild(noDataMessage);
        } else {
            Object.entries(data).forEach(([key, item]) => {
                const card = createBacklogCard(item, key);
                container.appendChild(card);
            });
        }

        // Always add the "Add" button
        const addButton = document.createElement('button');
        addButton.className = 'btn btn-lg btn-8-style btn-c-7647';
        addButton.onclick = handleAddButtonClick;
        addButton.innerHTML = '<span class="fa fa-plus"></span>';
        container.appendChild(addButton);
    }

    function createBacklogCard(item, key) {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.setAttribute('data-item-id', key);  // Add this line to set the item ID on the card
        const timeCreated = item.history && item.history.length > 0 ? item.history[0].timestamp : 'No creation date available';
        card.innerHTML = `
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="mg-clear">${item.title}</h3>
      <div class="dropdown">
        <button class="btn btn-link dropdown-toggle three-dot-menu" type="button" id="dropdownMenu-${key}" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${key}">
          <li><a class="dropdown-item text-danger delete-item" href="#" data-item-id="${key}">Delete</a></li>
          <li><a class="dropdown-item text-primary edit-item" href="#" data-item-id="${key}">Edit</a></li>
        </ul>
      </div>
    </div>
    <div class="card-body">
      <p>${item.description}</p>
      <div class="d-flex mb-2">
        <button class="btn btn-secondary me-2 card-tag" disabled style="background-color: ${getPriorityColor(item.priority)}">${item.priority}</button>
        <button class="btn btn-secondary card-tag" disabled>${item.assignee}</button>
      </div>
      <div class="tags-container">${renderCardTags(item.tags)}</div>
            <div class="mt-2"><small>Created on: ${timeCreated}</small></div>
    </div>
  `;
        return card;
    }


    function renderCardTags(tags) {
        return tags ? tags.map(tag => `<div class="tag" style="background-color: ${tag.color}; color: black;">${tag.name}</div>`).join('') : '';
    }

    function getPriorityColor(priority) {
        const colors = {'Low': '#C6F4D6', 'Medium': '#F7DC6F', 'Important': '#FFC0CB', 'Urgent': '#FFD7BE'};
        return colors[priority] || '#6E6AF0';
    }

    function togglePopup() {
        const popup = document.getElementById('popupForm');
        const overlay = document.getElementById('overlay');

        popup.classList.toggle('open');
        overlay.classList.toggle('open');

        if (!popup.classList.contains('open')) {
            // Reset form state without changing buttons
            const form = document.getElementById('backlogForm');
            form.reset();
            Array.from(form.elements).forEach(el => el.disabled = false);
            window.tags = [];
            renderPopupTags();
        }
    }

    function renderPopupTags(isViewMode = false) {
        const tagsContainer = document.getElementById('popup-tags-container');
        tagsContainer.innerHTML = '';

        // Loop through and render the tags
        if (Array.isArray(window.tags)) {
            window.tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.classList.add('tag');
                tagElement.style.backgroundColor = tag.color;
                tagElement.textContent = tag.name;

                // In view mode, tags should not be clickable
                if (!isViewMode) {
                    tagElement.addEventListener('click', () => {
                        window.tags = window.tags.filter(t => t.name !== tag.name);
                        renderPopupTags();
                    });
                }

                tagsContainer.appendChild(tagElement);
            });
        }

        // Hide or show the "Add Tag" button based on the mode
        const addTagButton = document.getElementById('add-tag-button');
        if (isViewMode) {
            addTagButton.style.display = 'none'; // Hide the button in view mode
        } else {
            addTagButton.style.display = 'inline-block'; // Show the button in edit/add mode
        }
    }


    function showTagSelectionPopup() {
        const tagSelectionPopup = document.getElementById('tag-selection-popup');
        const tagSelection = document.getElementById('tag-selection');
        tagSelection.innerHTML = '';
        availableTags.forEach((tag, index) => {
            const tagElement = document.createElement('div');
            tagElement.classList.add('tag-selection-tag');
            tagElement.style.backgroundColor = tagColors[index % tagColors.length];
            tagElement.textContent = tag;
            tagElement.addEventListener('click', () => {
                if (!window.tags.some(t => t.name === tag)) {
                    window.tags.push({name: tag, color: tagColors[index % tagColors.length]});
                }
                renderPopupTags();
                hideTagSelectionPopup();
            });
            tagSelection.appendChild(tagElement);
        });
        tagSelectionPopup.classList.add('open');
    }

    function hideTagSelectionPopup() {
        document.getElementById('tag-selection-popup').classList.remove('open');
    }

    function setPriority(p) {
        if (!p) {
            console.warn("Priority is undefined or missing");  // Add a warning if the priority is missing
            return;
        }

        priority = p;
        document.querySelectorAll('.pill-button.priority-low, .pill-button.priority-medium, .pill-button.priority-urgent, .pill-button.priority-important')
            .forEach(button => button.classList.remove('selected'));
        document.querySelector(`.pill-button.priority-${p.toLowerCase()}`).classList.add('selected');
        document.getElementById('priority-input').value = p;
    }


    function setStatus(status) {
        // Clear any previously selected status buttons
        document.querySelectorAll('.pill-button.status-not-started, .pill-button.status-in-progress, .pill-button.status-done').forEach(button => {
            button.classList.remove('selected');
        });

        // Select the appropriate status button
        const statusClassMap = {
            'Not started': '.pill-button.status-not-started',
            'In progress': '.pill-button.status-in-progress',
            'Done': '.pill-button.status-done'
        };

        const statusButton = document.querySelector(statusClassMap[status]);
        if (statusButton) {
            statusButton.classList.add('selected');
        } else {
            console.warn("Unknown status:", status);
        }

        // Set hidden input value (if needed)
        document.getElementById('status-input').value = status;
    }


    function setStage(stage) {
        if (!stage) {
            console.warn("Stage is undefined or missing");
            return;
        }

        // Clear previous selections
        document.querySelectorAll('.pill-button.stage-planning, .pill-button.stage-development, .pill-button.stage-testing, .pill-button.stage-integration')
            .forEach(button => button.classList.remove('selected'));

        // Try to select the button for the given stage
        const stageButton = document.querySelector(`.pill-button.stage-${stage.toLowerCase()}`);

        // Check if the stage button exists before trying to add a class
        if (stageButton) {
            stageButton.classList.add('selected');
            document.getElementById('stage-input').value = stage;
        } else {
            console.warn("Stage button not found for:", stage);
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('#popupForm form').addEventListener('submit', e => {
            e.preventDefault();
            window.sendFormDataToFirebase();
        });
    });

    function handleSaveChanges() {
        if (typeof window.sendFormDataToFirebase === 'function') {
            window.sendFormDataToFirebase();
        } else {
            console.error('sendFormDataToFirebase is not defined');
        }
    }

    window.showDeleteConfirmation = key => {
        window.itemToDelete = key;
        document.getElementById('delete-confirmation-popup').style.display = 'block';
    }

    window.hideDeleteConfirmation = () => {
        document.getElementById('delete-confirmation-popup').style.display = 'none';
    }

    window.confirmDelete = () => {
        if (window.itemToDelete) {
            window.deleteData(`productBacklog/${window.itemToDelete}`);

            // Remove the corresponding card from the DOM
            const cardToRemove = document.querySelector(`[data-item-id="${window.itemToDelete}"]`);
            if (cardToRemove) {
                cardToRemove.remove();
            }
        }
    }


    function showSortingPopup() {
        document.getElementById('sorting-popup').style.display = 'block';
    }

    function hideSortingPopup() {
        document.getElementById('sorting-popup').style.display = 'none';
    }

    function applySorting() {
        currentSortOption = document.querySelector('input[name="sort-option"]:checked').value;
        hideSortingPopup();
        fetchProductBacklog();
    }

    function sortBacklogItems(items) {
        if (!items || Object.keys(items).length === 0) {
            return {};
        }
        const itemsArray = Object.entries(items).map(([key, value]) => ({key, ...value}));
        const priorityValues = {'Low': 1, 'Medium': 2, 'Important': 3, 'Urgent': 4};
        const sortFunctions = {
            'oldest-recent': (a, b) => a.timestamp - b.timestamp,
            'recent-oldest': (a, b) => b.timestamp - a.timestamp,
            'low-important': (a, b) => (priorityValues[a.priority] || 0) - (priorityValues[b.priority] || 0),
            'important-low': (a, b) => (priorityValues[b.priority] || 0) - (priorityValues[a.priority] || 0),
        };
        itemsArray.sort(sortFunctions[currentSortOption] || sortFunctions['recent-oldest']);
        return Object.fromEntries(itemsArray.map(item => [item.key, item]));
    }


    function showFilterPopup() {
        document.getElementById('filter-popup').style.display = 'block';
    }

    function hideFilterPopup() {
        document.getElementById('filter-popup').style.display = 'none';
    }

    function applyFilter() {
        hideFilterPopup();
        fetchProductBacklog();
    }


    function filterBacklogItems(items) {
        if (!items || Object.keys(items).length === 0) {
            return {};
        }
        const itemsArray = Object.entries(items).map(([key, value]) => ({key, ...value}));

        if (currentFilterOption.length === 0) {
            return items;
        }

        const filteredItemsArray = itemsArray.filter(item => {
            const itemTags = item.tags ? item.tags.map(tag => tag.name) : [];
            const filterTags = currentFilterOption;

            return itemTags.length === filterTags.length &&
                filterTags.every(tag => itemTags.includes(tag)) &&
                itemTags.every(tag => filterTags.includes(tag));
        });

        return filteredItemsArray.length === 0 ? {} :
            Object.fromEntries(filteredItemsArray.map(item => [item.key, item]));
    }


    function toggleFilterTagSelection(button, tag) {
        button.classList.toggle('selected');

        if (button.classList.contains('selected')) {
            if (!currentFilterOption.includes(tag)) {
                currentFilterOption.push(tag);
            }
        } else {
            currentFilterOption = currentFilterOption.filter(t => t !== tag);
        }

    }


    function openFormInViewMode(item) {
        console.log('Opening form in view mode with item:', item);

        const form = document.getElementById('backlogForm');

        // Prefill form fields
        form.elements['title'].value = item.title || '';
        form.elements['description'].value = item.description || '';
        form.elements['assignee'].value = item.assignee || '';

        // Set priority
        if (item.priority) {
            setPriority(item.priority);
        } else {
            console.warn("Priority is missing for item:", item);
        }

        // Set status
        setStatus(item.status || 'Not started');

        // Set stage
        if (item.stage) {
            setStage(item.stage);
        } else {
            console.warn("Stage is missing for item:", item);
        }

        form.elements['storypoint'].value = item.storypoint || '';

        // Populate 'timeCreated' field in view mode (use 'timeCreated' or fallback to history)
        form.elements['timeCreated'].value = item.timeCreated || (item.history && item.history.length > 0 ? `Created on ${item.history[0].timestamp}` : 'No creation date available');

        window.tags = item.tags || [];

        // Render tags
        renderPopupTags(true);

        // Disable all form fields
        Array.from(form.elements).forEach(el => el.disabled = true);

        // Change buttons: Only "Back"
        const buttons = document.querySelector('.form-buttons');
        buttons.innerHTML = '<button type="button" class="btn btn-secondary" onclick="togglePopup()">Back</button>';

        // Open popup
        togglePopup();
        renderTimeline(item.history || []);
    }


    function setFormMode(mode, item = null) {
        console.log(`Setting form mode to: ${mode}`); // Debug log
        const form = document.getElementById('backlogForm');
        const buttons = document.querySelector('.form-buttons');

        // Always clear the buttons first
        buttons.innerHTML = '';

        if (mode === 'edit' && item) {
            fillFormWithItemData(item);
            buttons.innerHTML = `
  <button type="button" class="btn btn-secondary" onclick="togglePopup()">Cancel</button>
  <button type="button" class="btn btn-primary" onclick="updateBacklogItem('${item.key}')">Update</button>
`;
        } else if (mode === 'add') {
            console.log('Entering add mode'); // Debug log
            // Force reset for add mode
            form.reset();
            window.tags = [];
            renderPopupTags();
            const timelineContainer = document.getElementById('timeline-events');
            timelineContainer.innerHTML = ''; // Reset the timeline
            setPriority('Low');  // Default to 'Low'
            setStatus('Not started');  // Default to 'Not started'
            setStage('Planning');  // Default to 'Planning'


            // Enable all form fields
            Array.from(form.elements).forEach(el => el.disabled = false);

            // Set the current time for the timeCreated field
            form.elements['timeCreated'].value = new Date().toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).replace(/\//g, '-');

            // Force the correct buttons for add mode
            buttons.innerHTML = `
            <button type="button" class="btn btn-secondary" onclick="togglePopup()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="handleSaveChanges()">Save Changes</button>
        `;
            console.log('Add mode buttons set:', buttons.innerHTML); // Debug log
        } else if (mode === 'view') {
            fillFormWithItemData(item);
            Array.from(form.elements).forEach(el => el.disabled = true);
            buttons.innerHTML = '<button type="button" class="btn btn-secondary" onclick="togglePopup()">Back</button>';
        }

        // Force the popup to open
        const popup = document.getElementById('popupForm');
        const overlay = document.getElementById('overlay');
        popup.classList.add('open');
        overlay.classList.add('open');
    }

    window.handleAddButtonClick = function (event) {
        console.log('Add button clicked'); // Debug log
        event.preventDefault();
        console.log('Add button clicked'); // Debug log
        setFormMode('add');
    };

    function fillFormWithItemData(item) {
        const form = document.getElementById('backlogForm');
        form.elements['title'].value = item.title || '';
        form.elements['description'].value = item.description || '';
        form.elements['assignee'].value = item.assignee || '';
        setPriority(item.priority || '');
        setStatus(item.status || 'Not started');
        setStage(item.stage || '');
        form.elements['storypoint'].value = item.storypoint || '';
        window.tags = item.tags || [];
        renderPopupTags();

        // Render the timeline
        if (item.history && item.history.length > 0) {
            form.elements['timeCreated'].value = `Created on ${item.history[0].timestamp}`;
        } else {
            form.elements['timeCreated'].value = item.timeCreated || '';
        }
        renderTimeline(item.history || []);
    }


    function renderTimeline(history) {
        const timelineContainer = document.getElementById('timeline-events');
        timelineContainer.innerHTML = '';

        // Reverse the history array to display the most recent item at the top
        history.slice().reverse().forEach((event, index) => {
            const timelineEvent = document.createElement('div');
            timelineEvent.className = 'timeline-event';

            const dot = document.createElement('div');
            dot.className = 'timeline-dot';

            const content = document.createElement('div');
            content.className = 'timeline-content';

            const actionTime = document.createElement('p');
            actionTime.textContent = `${event.action} on ${event.timestamp} \n | by: test1`;
            actionTime.style.fontFamily = 'Poppins, sans-serif';
            actionTime.style.width = '45%';
            actionTime.style.marginRight = '10px';
            actionTime.style.float = 'left';


            const changes = document.createElement('p');
            changes.textContent = event.changes;
            changes.style.fontFamily = 'Poppins, sans-serif';
            changes.style.width = '45%';
            changes.style.float = 'right';
            changes.style.marginTop = '10px';

            // Truncate text if it's too long
            if (changes.textContent.length > 50) {
                changes.textContent = changes.textContent.substring(0, 47) + '...';
            }

            content.appendChild(actionTime);
            content.appendChild(changes);

            timelineEvent.appendChild(dot);
            timelineEvent.appendChild(content);

            timelineContainer.appendChild(timelineEvent);
        });
    }

</script>
<script type="module">
    // Import necessary modules
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
        getDatabase,
        ref,
        push,
        get,
        remove,
        update,
        onValue
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDicFj4DUKZo2iYXZN8tUE2FcMLqmQ_cgU",
        authDomain: "izuck-digital.firebaseapp.com",
        databaseURL: "https://izuck-digital-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "izuck-digital",
        storageBucket: "izuck-digital.appspot.com",
        messagingSenderId: "875586622876",
        appId: "1:875586622876:web:dab65a8d81690d7a18e459",
        measurementId: "G-1YRPZNH521"
    };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const productBacklogRef = ref(database, 'productBacklog');

    // Function to fetch product backlog
    window.fetchProductBacklog = async function () {
        try {
            const snapshot = await get(productBacklogRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                const result = currentFilterOption.length > 0 ? filterBacklogItems(data) : sortBacklogItems(data);
                window.renderProductBacklog(result);
            } else {
                console.log("No data available");
            }
        } catch (error) {
            console.error("Error fetching product backlog:", error);
        }
    }

    function setupRealtimeListener() {
        const productBacklogRef = ref(database, 'productBacklog');
        onValue(productBacklogRef, (snapshot) => {
            let data = snapshot.val();
            if (data === null) {
                data = {}; // Ensure we're always working with an object
            }
            const result = currentFilterOption.length > 0 ? filterBacklogItems(data) : sortBacklogItems(data);
            window.renderProductBacklog(result);
        });
    }

    // Function to send form data to Firebase
    window.sendFormDataToFirebase = async function () {
        try {
            const formData = getFormData();
            if (Object.values(formData).some(value => value === '')) {
                alert('Please fill in all fields');
                return;
            }

            await push(productBacklogRef, formData);
            console.log('Data saved successfully');
            togglePopup();
        } catch (error) {
            console.error("Error sending form data:", error);
        }
    }

    // Function to get form data
    function getFormData() {
        return {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            assignee: document.getElementById('assignee').value,
            priority: document.getElementById('priority-input').value,
            status: document.getElementById('status-input').value,
            stage: document.getElementById('stage-input').value,
            storypoint: document.getElementById('storypoint').value,
            history: [{
                action: 'Created',
                timestamp: new Date().toLocaleString('en-GB', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }).replace(/\//g, '-'),
                changes: 'Item created'
            }],
            timeModified: new Date().toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).replace(/\//g, '-'),
            timestamp: Date.now(),
            tags: window.tags || []
        };
    }

    // Function to handle delete item
    window.deleteData = async function (path) {
        try {
            await remove(ref(database, path));
            console.log("Data deleted successfully");
            hideDeleteConfirmation();
            // The listener will automatically update the UI
        } catch (error) {
            console.error("Error deleting data:", error);
        }
    }

    // Function to handle update item
    window.updateBacklogItem = async function (itemId) {
        try {
            const formData = getFormDataForUpdate(itemId);
            const currentData = await get(ref(database, `productBacklog/${itemId}`));
            if (currentData.exists()) {
                const changes = getChanges(currentData.val(), formData);
                const updatedData = updateItemHistory(currentData.val(), formData, changes);
                await update(ref(database, `productBacklog/${itemId}`), updatedData);
                console.log('Data updated successfully');
                togglePopup();
            }
        } catch (error) {
            console.error("Error updating data:", error);
        }
    }

    // Function to get form data for update
    function getFormDataForUpdate(itemId) {
        const form = document.getElementById('backlogForm');
        return {
            title: form.elements['title'].value,
            description: form.elements['description'].value,
            assignee: form.elements['assignee'].value,
            priority: document.getElementById('priority-input').value,
            status: document.getElementById('status-input').value,
            stage: document.getElementById('stage-input').value,
            storypoint: form.elements['storypoint'].value,
            timeCreated: form.elements['timeCreated'].value,
            tags: window.tags || [],
            timeModified: new Date().toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).replace(/\//g, '-'),
        };
    }

    // Function to update item history
    function updateItemHistory(currentData, formData, changes) {
        if (!currentData.history) currentData.history = [];
        currentData.history.push({
            action: 'Modified',
            timestamp: new Date().toLocaleString('en-GB', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).replace(/\//g, '-'),
            changes: changes
        });

        formData.history = currentData.history;
        return formData;
    }

    // Function to get changes
    function getChanges(oldData, newData) {
        const changes = [];
        for (const key in newData) {
            if (key !== 'timeModified' && key !== 'timeCreated' && key !== 'history' && JSON.stringify(oldData[key]) !== JSON.stringify(newData[key])) {
                changes.push(`${key} updated`);
            }
        }

        // Format the changes text
        if (changes.length > 1) {
            return changes.join(', ');
        } else if (changes.length === 1) {
            return changes[0];
        } else {
            return 'No changes';
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        fetchProductBacklog();
        document.getElementById('sortButton').addEventListener('click', showSortingPopup);
        document.getElementById('filterButton').addEventListener('click', showFilterPopup);
    });

    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-item')) {
            event.preventDefault();
            showDeleteConfirmation(event.target.getAttribute('data-item-id'));
        }
    });

    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('edit-item')) {
            event.preventDefault();
            const itemId = event.target.getAttribute('data-item-id');
            get(ref(database, `productBacklog/${itemId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const item = snapshot.val();
                    item.key = itemId;
                    setFormMode('edit', item);
                }
            }).catch(console.error);
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const addButton = document.querySelector('.btn-lg.btn-8-style');
        if (addButton) {
            addButton.addEventListener('click', function (event) {
                console.log('Add button clicked via event listener');
                handleAddButtonClick(event);
            });
        } else {
            console.error('Add button not found');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        setupRealtimeListener();
        document.getElementById('sortButton').addEventListener('click', showSortingPopup);
        document.getElementById('filterButton').addEventListener('click', showFilterPopup);
    });

    window.setupRealtimeListener = setupRealtimeListener;
    window.fetchProductBacklog = fetchProductBacklog;
    window.sendFormDataToFirebase = sendFormDataToFirebase;
    document.querySelector('.btn-lg.btn-8-style').addEventListener('click', function (event) {
        event.preventDefault();
        setFormMode('add');
    });

    document.getElementById('overlay').addEventListener('click', function () {
        togglePopup();
    });

    document.addEventListener('click', (event) => {
        const card = event.target.closest('.card');
        if (card && !event.target.closest('.dropdown, .btn-link')) {
            const itemId = card.getAttribute('data-item-id');
            if (itemId) {
                get(ref(database, `productBacklog/${itemId}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const item = snapshot.val();
                        item.key = itemId;
                        openFormInViewMode(item);
                    }
                }).catch(console.error);
            }
        }
    });
</script>
</body>