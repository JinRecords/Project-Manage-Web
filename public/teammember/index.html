<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sprint Board</title>
    <link rel="shortcut icon" type="image/jpeg" href="../favicon.jpeg">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css?2917">
    <link rel="stylesheet" type="text/css" href="../style.css?4034">
    <link rel="stylesheet" type="text/css" href="../css/animate.min.css?9837">
    <link rel="stylesheet" type="text/css" href="../css/feather.min.css">
    <link rel="stylesheet" type="text/css" href="../css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../css/ionicons.min.css">
    <link rel="stylesheet" type="text/css" href="../css/teammember.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins:100,500,700,40&display=swap&subset=latin,latin-ext'
          rel='stylesheet' type='text/css'>
    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {getDatabase, ref, push} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    </script>
</head>
<body data-clean-url="true">

<!-- Preloader -->
<div id="page-loading-blocs-notifaction" class="page-preloader"></div>

<!-- Main container -->
<div class="page-container">
    <!-- Logo Sidebar -->
    <div class="logo-sidebar">
        <div class="icon-container">
            <picture>
                <source type="image/webp" srcset="../img/lazyload-ph.png" data-srcset="../img/favicon.webp">
                <img src="../img/lazyload-ph.png" data-src="../img/favicon.jpeg" class="lazyload" alt="favicon.jpeg">
            </picture>
            <div class="text-center mt-lg-4">
                <span class="icon-md feather-icon icon-content-left icon-672"></span>
            </div>
        </div>
    </div>


    <!-- Links Sidebar -->
    <div class="links-sidebar">
        <div class="button-container">
            <a href="../backlog/index.html"
               class=" btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-laptop icon-7097 me-lg-3 "></span>Product Backlog
            </a>
            <a href="../sprintboard/index.html"
               class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-running icon-7097 icon-md me-lg-3"></span>Sprint Board
            </a>
            <a href="../teammember/index.html"
               class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 product-backlog-btn btn-clean-clicked">
                <span class="icon-spacer ion ion-android-people icon-7647 icon-md me-lg-3"></span>Team members
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="bloc l-bloc" id="bloc-1">
            <div class="container bloc-lg">
                <div class="row align-items-center">
                    <div class="col">
                        <!-- User Cards Container -->
                        <div id="userCardsContainer" class="user-cards-container">
                            <!-- User cards will be dynamically added here -->
                        </div>
                        <div class="form-group mb-3">
                            <button class="btn btn-lg btn-9-style btn-c-7647" id="addMemberButton">
                                <span class="fa fa-plus"></span> Add Team member
                            </button>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this to your HTML, preferably just before the closing </body> tag -->
    <div id="addMemberPopup" class="popup-form">
        <form id="addMemberForm">
            <div class="form-group">
                <label for="newUsername">Username</label>
                <input type="text" class="form-control" id="newUsername" required>
            </div>
            <div class="form-group">
                <label for="newPassword">Password</label>
                <input type="password" class="form-control" id="newPassword" required>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="closePopup()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewMember()">Save Changes</button>
            </div>
        </form>
    </div>


    <!-- Delete Confirmation Popup -->
    <div id="deleteConfirmationPopup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Confirm Deletion</h4>
            <p>Are you sure you want to delete this team member?</p>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>


    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>


    <!-- ScrollToTop Button -->
    <button aria-label="Scroll to top button" class="bloc-button btn btn-d scrollToTop"
            onclick="scrollToTarget('1',this)">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
            <path class="scroll-to-top-btn-icon" d="M30,22.656l-14-13-14,13"/>
        </svg>
    </button>
</div>

<script src="../js/bootstrap.bundle.min.js?3058"></script>
<script src="../js/blocs.min.js?6353"></script>
<script src="../js/lazysizes.min.js" defer></script>
<script>
    // Global variables
    let currentSprintId = null;

    // Function to handle adding a new sprint
    window.handleAddMemberClick = function (event) {
        event.preventDefault();
        setMemberFormMode('add');
    }


    // Function to show delete confirmation
    function showDeleteConfirmation(sprintId) {
        const popup = document.getElementById('delete-confirmation-popup');
        popup.style.display = 'block';
        document.getElementById('overlay').classList.add('open');

        // Set up event listeners for delete confirmation
        document.querySelector('#delete-confirmation-popup .btn-secondary').onclick = hideDeleteConfirmation;
        document.querySelector('#delete-confirmation-popup .btn-danger').onclick = () => {
            deleteMember(sprintId);
            hideDeleteConfirmation();
        };
    }

    // Function to hide delete confirmation
    function hideDeleteConfirmation() {
        document.getElementById('delete-confirmation-popup').style.display = 'none';
        document.getElementById('overlay').classList.remove('open');
    }

</script>
<script type="module">
    // Import necessary modules
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
        getDatabase,
        ref,
        push,
        get,
        set,
        remove,
        update,
        onValue
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Firebase configuration (same as Product Backlog)
    const firebaseConfig = {
        apiKey: "AIzaSyDicFj4DUKZo2iYXZN8tUE2FcMLqmQ_cgU",
        authDomain: "izuck-digital.firebaseapp.com",
        databaseURL: "https://izuck-digital-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "izuck-digital",
        storageBucket: "izuck-digital.appspot.com",
        messagingSenderId: "875586622876",
        appId: "1:875586622876:web:dab65a8d81690d7a18e459",
        measurementId: "G-1YRPZNH521"
    };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const sprintBoardRef = ref(database, 'sprintboard');

    // Function to toggle the add member popup
    function toggleAddMemberPopup() {
        console.log("clicked")
        const popup = document.getElementById('addMemberPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.toggle('open');
        overlay.style.display = popup.classList.contains('open') ? 'block' : 'none';
    }

    function closePopup() {
        const popup = document.getElementById('addMemberPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.remove('open');
        overlay.style.display = 'none';
        document.getElementById('addMemberForm').reset(); // Reset the form when closing
    }

    window.saveNewMember = function () {
        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newPassword').value;

        if (username && password) {
            const newUserRef = ref(database, `users/${username}`);
            set(newUserRef, {
                username: username,
                password: password
            }).then(() => {
                console.log('New member added successfully');
                closePopup(); // Close the popup after successful save
                document.getElementById('addMemberForm').reset();
            }).catch((error) => {
                console.error('Error adding new member:', error);
            });
        } else {
            alert('Please fill in both fields');
        }
    };

    // Make sure these functions are global
    window.toggleAddMemberPopup = toggleAddMemberPopup;
    window.closePopup = closePopup;


    // Add event listener to the add member button
    document.getElementById('addMemberButton').addEventListener('click', toggleAddMemberPopup);


    // Function to fetch user data and create cards
    function fetchUserDataAndCreateCards() {
        const userCardsContainer = document.getElementById('userCardsContainer');
        const usersRef = ref(database, 'users');

        onValue(usersRef, (snapshot) => {
            userCardsContainer.innerHTML = ''; // Clear existing cards
            const userData = snapshot.val();

            for (const userId in userData) {
                const user = userData[userId];
                const card = createUserCard(user);
                userCardsContainer.appendChild(card);
            }
        });
    }

    // Function to create a user card
    function createUserCard(user) {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
        <div class="card-header">
            <h3>${user.username}</h3>
            <div class="dropdown">
                <button class="btn btn-link dropdown-toggle three-dot-menu" type="button" id="dropdownMenu-${user.username}" data-bs-toggle="dropdown" aria-expanded="false">â‹®</button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${user.username}">
                    <li><a class="dropdown-item text-danger delete-item" href="#" data-username="${user.username}">Delete</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <p>Team member</p>
            <button class="btn btn-secondary" disabled>User</button>
        </div>
    `;

        // Add event listener for delete button
        const deleteButton = card.querySelector('.delete-item');
        deleteButton.addEventListener('click', (e) => {
            e.preventDefault();
            showDeleteConfirmation(user.username);
        });

        return card;
    }


    let userToDelete = null;

    function showDeleteConfirmation(username) {
        userToDelete = username;
        const popup = document.getElementById('deleteConfirmationPopup');
        const overlay = document.getElementById('overlay');
        popup.style.display = 'block';
        overlay.style.display = 'block';
    }

    function hideDeleteConfirmation() {
        const popup = document.getElementById('deleteConfirmationPopup');
        const overlay = document.getElementById('overlay');
        popup.style.display = 'none';
        overlay.style.display = 'none';
        userToDelete = null;
    }

    function confirmDelete() {
        if (userToDelete) {
            const userRef = ref(database, `users/${userToDelete}`);
            remove(userRef).then(() => {
                console.log('User deleted successfully');
                hideDeleteConfirmation();
                fetchUserDataAndCreateCards(); // Refresh the user list
            }).catch((error) => {
                console.error('Error deleting user:', error);
            });
        }
    }

    // Make these functions global
    window.showDeleteConfirmation = showDeleteConfirmation;
    window.hideDeleteConfirmation = hideDeleteConfirmation;
    window.confirmDelete = confirmDelete;


    // Call this function when the page loads
    document.addEventListener('DOMContentLoaded', fetchUserDataAndCreateCards);


</script>
</body>
</html>
