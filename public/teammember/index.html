<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sprint Board</title>
    <link rel="shortcut icon" type="image/jpeg" href="../favicon.jpeg">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css?2917">
    <link rel="stylesheet" type="text/css" href="../style.css?4034">
    <link rel="stylesheet" type="text/css" href="../css/animate.min.css?9837">
    <link rel="stylesheet" type="text/css" href="../css/feather.min.css">
    <link rel="stylesheet" type="text/css" href="../css/all.min.css">
    <link rel="stylesheet" type="text/css" href="../css/ionicons.min.css">
    <link rel="stylesheet" type="text/css" href="../css/teammember.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins:100,500,700,40&display=swap&subset=latin,latin-ext'
          rel='stylesheet' type='text/css'>
    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {getDatabase, ref, push} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    </script>
</head>
<body data-clean-url="true">

<!-- Preloader -->
<div id="page-loading-blocs-notifaction" class="page-preloader"></div>

<!-- Main container -->
<div class="page-container">
    <!-- Logo Sidebar -->
    <div class="logo-sidebar">
        <div class="icon-container">
            <picture>
                <source type="image/webp" srcset="../img/lazyload-ph.png" data-srcset="../img/favicon.webp">
                <img src="../img/lazyload-ph.png" data-src="../img/favicon.jpeg" class="lazyload" alt="favicon.jpeg">
            </picture>
            <div class="text-center mt-lg-4">
                <span class="icon-md feather-icon icon-content-left icon-672"></span>
            </div>
        </div>
    </div>


    <!-- Links Sidebar -->
    <div class="links-sidebar">
        <div class="button-container">
            <a href="../backlog/index.html"
               class=" btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-laptop icon-7097 me-lg-3 "></span>Product Backlog
            </a>
            <a href="../sprintboard/index.html"
               class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 float-lg-none">
                <span class="icon-spacer fa fa-running icon-7097 icon-md me-lg-3"></span>Sprint Board
            </a>
            <a href="../teammember/index.html"
               class="btn btn-lg btn-button-style mt-lg-2 btn-c-7647 mb-lg-3 product-backlog-btn btn-clean-clicked">
                <span class="icon-spacer ion ion-android-people icon-7647 icon-md me-lg-3"></span>Team members
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="bloc l-bloc" id="bloc-1">
            <div class="container bloc-lg">
                <div class="row align-items-center">
                    <div class="col">
                        <!-- User Cards Container -->
                        <div id="userCardsContainer" class="user-cards-container">
                            <!-- User cards will be dynamically added here -->
                        </div>
                        <div class="form-group mb-3">
                            <button class="btn btn-lg btn-9-style btn-c-7647" id="addMemberButton">
                                <span class="fa fa-plus"></span> Add Team member
                            </button>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this to your HTML, preferably just before the closing </body> tag -->
    <div id="addMemberPopup" class="popup-form">
        <form id="addMemberForm">
            <div class="form-group">
                <label for="newUsername">Username</label>
                <input type="text" class="form-control" id="newUsername" required>
            </div>
            <div class="form-group">
                <label for="newPassword">Password</label>
                <input type="password" class="form-control" id="newPassword" required>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="closePopup()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewMember()">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Delete Confirmation Popup -->
    <div id="deleteConfirmationPopup" class="custom-popup">
        <div class="custom-popup-content">
            <h4>Confirm Deletion</h4>
            <p>Are you sure you want to delete this team member?</p>
            <div class="custom-popup-buttons">
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- User Details Popup -->
    <div id="userDetailsPopup" class="popup-form">
        <form id="userForm">
            <div class="form-group">
                <h3 id="userUsername"></h3>
                <p><strong>Total Time Spent:</strong> <span id="userTotalTimeSpent"></span></p>
                <canvas id="userTimeSpentChart"></canvas>
                <div class="col-auto ml-auto">
                    <button type="button" id="filterButton" class="btn btn-secondary"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideUserDetails()">Close</button>
            </div>
        </form>
    </div>

    <!-- Filter by time spent popup-->
    <div id="filter-time-spent-popup" class="filter-time-spent-popup">
        <div class="custom-popup-content">
            <h4>Filter By Date Range</h4>
            <div id="filter-option">
                <div class="form-group">
                    <label for="start-date">Start Date:</label>
                    <input type="date" id="start-date" class="form-control">
                </div>
                <div class="form-group">
                    <label for="end-date">End Date:</label>
                    <input type="date" id="end-date" class="form-control">
                </div>
                <div class="custom-popup-buttons">
                    <button class="btn btn-secondary" onclick="hideFilterTimeSpentPopup()">Cancel</button>
                    <button class="btn btn-primary" onclick="applyDateFilter()">Apply</button>
                    <button class="btn btn-warning" onclick="resetDateFilter()">Reset</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>


    <!-- ScrollToTop Button -->
    <button aria-label="Scroll to top button" class="bloc-button btn btn-d scrollToTop"
            onclick="scrollToTarget('1',this)">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 32 32">
            <path class="scroll-to-top-btn-icon" d="M30,22.656l-14-13-14,13"/>
        </svg>
    </button>
</div>

<script src="../js/bootstrap.bundle.min.js?3058"></script>
<script src="../js/blocs.min.js?6353"></script>
<script src="../js/lazysizes.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let currentSprintId = null;
    let timeSpentData = {};
    let userTimeSpentChartInstance = null;

    // Function to handle adding a new sprint
    window.handleAddMemberClick = function (event) {
        event.preventDefault();
        setMemberFormMode('add');
    }


    // Function to show delete confirmation
    function showDeleteConfirmation(sprintId) {
        const popup = document.getElementById('delete-confirmation-popup');
        popup.style.display = 'block';
        document.getElementById('overlay').classList.add('open');

        // Set up event listeners for delete confirmation
        document.querySelector('#delete-confirmation-popup .btn-secondary').onclick = hideDeleteConfirmation;
        document.querySelector('#delete-confirmation-popup .btn-danger').onclick = () => {
            deleteMember(sprintId);
            hideDeleteConfirmation();
        };
    }

    // Function to hide delete confirmation
    function hideDeleteConfirmation() {
        document.getElementById('delete-confirmation-popup').style.display = 'none';
        document.getElementById('overlay').classList.remove('open');
    }

    // Function to show user detail
    function showUserDetails(user) {
        const popup = document.getElementById('userDetailsPopup');
        const overlay = document.getElementById('overlay');

        document.getElementById('userUsername').textContent = user.username;

        // Reset the chart canvas
        const chartCanvas = document.getElementById('userTimeSpentChart');
        chartCanvas.width = chartCanvas.width;

        // Fetch time spent data for the user
        fetchUserTimeSpentData(user.username).then(data => {
            timeSpentData = data;
            const totalTimeSpent = calculateTotalTimeSpent(timeSpentData);
            document.getElementById('userTotalTimeSpent').textContent = totalTimeSpent;

            renderUserTimeSpentChart(timeSpentData);
        });

        // Add event listener for the filter button
        const filterButton = document.getElementById('filterButton');
        filterButton.addEventListener('click', showFilterTimeSpentPopup);

        popup.classList.add('open');
        overlay.style.display = 'block';
    }


    // Function to create bar chart
    function renderUserTimeSpentChart(timeSpentData) {
        const ctx = document.getElementById('userTimeSpentChart').getContext('2d');

        // Destroy the existing chart if it exists
        if (userTimeSpentChartInstance) {
            userTimeSpentChartInstance.destroy();
        }

        const dates = Object.keys(timeSpentData).sort();
        const timeSpent = dates.map(date => timeSpentData[date]);

        userTimeSpentChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Time Spent (hours)',
                    data: timeSpent,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Time Spent (hours)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    // Function to calculate time spend for user
    function calculateTotalTimeSpent(timespent) {
        if (!timespent || typeof timespent !== 'object') return '0 hours';

        const totalHours = Object.values(timespent).reduce((sum, value) => sum + value, 0);
        return `${totalHours.toFixed(2)} hours`;
    }

    // Function to show filter popup
    function showFilterTimeSpentPopup() {
        const popup = document.getElementById('filter-time-spent-popup');
        popup.style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    // Function to hide filter popup
    function hideFilterTimeSpentPopup() {
        const popup = document.getElementById('filter-time-spent-popup');
        popup.style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    // Function to filter by date
    function filterDataByDateRange(dates, durations, startDate, endDate) {
        const filteredDates = [];
        const filteredDurations = [];

        for (let i = 0; i < dates.length; i++) {
            if (dates[i] >= startDate && dates[i] <= endDate) {
                filteredDates.push(dates[i]);
                filteredDurations.push(durations[i]);
            }
        }

        return { dates: filteredDates, durations: filteredDurations };
    }

    function applyDateFilter() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (startDate && endDate) {
            const filteredData = filterDataByDateRange(Object.keys(timeSpentData), Object.values(timeSpentData), startDate, endDate);
            const filteredTimeSpentData = Object.fromEntries(filteredData.dates.map((date, index) => [date, filteredData.durations[index]]));

            const totalTimeSpent = calculateTotalTimeSpent(filteredTimeSpentData);
            document.getElementById('userTotalTimeSpent').textContent = totalTimeSpent;

            renderUserTimeSpentChart(filteredTimeSpentData);
            hideFilterTimeSpentPopup();
        } else {
            alert('Please select both start and end dates.');
        }
    }

    function resetDateFilter() {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        const totalTimeSpent = calculateTotalTimeSpent(timeSpentData);
        document.getElementById('userTotalTimeSpent').textContent = totalTimeSpent;
        renderUserTimeSpentChart(timeSpentData);
        hideFilterTimeSpentPopup();
    }


</script>
<script type="module">
    // Import necessary modules
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
        getDatabase,
        ref,
        push,
        get,
        set,
        remove,
        update,
        onValue
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Firebase configuration (same as Product Backlog)
    const firebaseConfig = {
        apiKey: "AIzaSyDicFj4DUKZo2iYXZN8tUE2FcMLqmQ_cgU",
        authDomain: "izuck-digital.firebaseapp.com",
        databaseURL: "https://izuck-digital-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "izuck-digital",
        storageBucket: "izuck-digital.appspot.com",
        messagingSenderId: "875586622876",
        appId: "1:875586622876:web:dab65a8d81690d7a18e459",
        measurementId: "G-1YRPZNH521"
    };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const sprintBoardRef = ref(database, 'sprintboard');

    // Function to toggle the add member popup
    function toggleAddMemberPopup() {
        console.log("clicked")
        const popup = document.getElementById('addMemberPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.toggle('open');
        overlay.style.display = popup.classList.contains('open') ? 'block' : 'none';
    }

    // Function to toggle progress popup
    function toggleProgressPopup() {
        console.log("Hahahah");
        const popup = document.getElementById('user-popup');
        popup.classList.toggle('open');
        console.log("Popup visibility:", popup.classList.contains('open'));
    }

    // Function to toggle filter popup
    function toggleFilterTimeSpentPopup() {
        const popup = document.getElementById('filter-time-spent-popup');
        popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
    }

    function closePopup() {
        const popup = document.getElementById('addMemberPopup');
        const overlay = document.getElementById('overlay');
        popup.classList.remove('open');
        overlay.style.display = 'none';
        document.getElementById('addMemberForm').reset(); // Reset the form when closing
    }

    window.saveNewMember = function () {
        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newPassword').value;

        if (username && password) {
            const newUserRef = ref(database, `users/${username}`);
            set(newUserRef, {
                username: username,
                password: password
            }).then(() => {
                console.log('New member added successfully');
                closePopup(); // Close the popup after successful save
                document.getElementById('addMemberForm').reset();
            }).catch((error) => {
                console.error('Error adding new member:', error);
            });
        } else {
            alert('Please fill in both fields');
        }
    };

    function hideUserDetails() {
        const popup = document.getElementById('userDetailsPopup');
        const overlay = document.getElementById('overlay');

        // Remove the event listener for the filter button
        const filterButton = document.getElementById('filterButton');
        filterButton.removeEventListener('click', showFilterTimeSpentPopup);

        popup.classList.remove('open');
        overlay.style.display = 'none';
    }

    // Make sure these functions are global
    window.toggleAddMemberPopup = toggleAddMemberPopup;
    window.closePopup = closePopup;
    window.hideUserDetails = hideUserDetails;

    // Add event listener to the add member button
    document.getElementById('addMemberButton').addEventListener('click', toggleAddMemberPopup);


    // Function to fetch user data and create cards
    function fetchUserDataAndCreateCards() {
        const userCardsContainer = document.getElementById('userCardsContainer');
        const usersRef = ref(database, 'users');

        onValue(usersRef, (snapshot) => {
            userCardsContainer.innerHTML = ''; // Clear existing cards
            const userData = snapshot.val();

            for (const userId in userData) {
                const user = userData[userId];
                // The timespent data is already in the user object
                console.log(`Timespent data for ${user.username}:`, user.timespent);
                const card = createUserCard(user);
                userCardsContainer.appendChild(card);
            }
        });
    }

    document.getElementById('overlay').addEventListener('click', function() {
        hideUserDetails();
    });

    // Function to create a user card
    function createUserCard(user) {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
            <div class="card-header">
                <h3>${user.username}</h3>
                <div class="dropdown">
                    <button class="btn btn-link dropdown-toggle three-dot-menu" type="button" id="dropdownMenu-${user.username}" data-bs-toggle="dropdown" aria-expanded="false">⋮</button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu-${user.username}">
                        <li><a class="dropdown-item text-danger delete-item" href="#" data-username="${user.username}">Delete</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <p>Team member</p>
                <button class="btn btn-secondary" disabled>User</button>
            </div>
        `;

        card.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown, .btn-link')) {
                showUserDetails(user);
            }
        });

        // Add event listener for delete button
        const deleteButton = card.querySelector('.delete-item');
        deleteButton.addEventListener('click', (e) => {
            e.preventDefault();
            showDeleteConfirmation(user.username);
        });

        return card;
    }


    let userToDelete = null;

    function showDeleteConfirmation(username) {
        userToDelete = username;
        const popup = document.getElementById('deleteConfirmationPopup');
        const overlay = document.getElementById('overlay');
        popup.style.display = 'block';
        overlay.style.display = 'block';
    }

    function hideDeleteConfirmation() {
        const popup = document.getElementById('deleteConfirmationPopup');
        const overlay = document.getElementById('overlay');
        popup.style.display = 'none';
        overlay.style.display = 'none';
        userToDelete = null;
    }

    function confirmDelete() {
        if (userToDelete) {
            const userRef = ref(database, `users/${userToDelete}`);
            remove(userRef).then(() => {
                console.log('User deleted successfully');
                hideDeleteConfirmation();
                fetchUserDataAndCreateCards(); // Refresh the user list
            }).catch((error) => {
                console.error('Error deleting user:', error);
            });
        }
    }

    window.fetchUserTimeSpentData = async function (username) {
        const userRef = ref(database, `users/${username}/timespent`);
        const snapshot = await get(userRef);
        return snapshot.val() || {};
    }

    window.fetchAndDisplayProgressData = async function (taskId, startDate = null, endDate = null, reset = false) {
        const userRef = ref(database, `users/${username}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            const task = snapshot.val();
            const progressLog = task.progressLog || {};

            let dates = Object.keys(progressLog).sort();
            let durations = dates.map(date => progressLog[date]);

            if (!reset && startDate && endDate) {
                const filteredData = filterDataByDateRange(dates, durations, startDate, endDate);
                dates = filteredData.dates;
                durations = filteredData.durations;
            }

            const totalTimeSpent = durations.reduce((sum, duration) => sum + duration, 0);

            renderProgressChart(dates, durations);

            document.getElementById('totalTimeSpent').textContent = totalTimeSpent.toFixed(2);
        } else {
            console.log("No progress data available");
        }
    }

    // Make these functions global
    window.showDeleteConfirmation = showDeleteConfirmation;
    window.hideDeleteConfirmation = hideDeleteConfirmation;
    window.confirmDelete = confirmDelete;


    // Call this function when the page loads
    document.addEventListener('DOMContentLoaded', fetchUserDataAndCreateCards);


</script>
</body>
</html>